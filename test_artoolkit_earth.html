<html>

  <body>
  </body>

  <script type="text/javascript" src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script src="artoolkit.min.js"></script>
  <script src="artoolkit.api.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/84/three.min.js"></script>


  <script type="text/javascript">

/*
var tagOrientations = JSON.parse('{"0":{"elements":{"0":1,"1":0,"2":0,"3":0,"4":0,"5":1,"6":0,"7":0,"8":0,"9":0,"10":1,"11":0,"12":0,"13":0,"14":0,"15":1}},"1":{"elements":{"0":-0.048528362065553665,"1":0.0335928313434124,"2":0.9982567429542542,"3":0,"4":0.014106669463217258,"5":0.9993576407432556,"6":-0.03294409438967705,"7":0,"8":-0.9987221956253052,"9":0.012483380734920502,"10":-0.048971131443977356,"11":0,"12":1.8318449258804321,"13":-0.11931201815605164,"14":1.8314937353134155,"15":1}},"2":{"elements":{"0":0.019809650257229805,"1":0.020982656627893448,"2":0.9995836019515991,"3":0,"4":-0.9991142749786377,"5":-0.03670883923768997,"6":0.02057092823088169,"7":0,"8":0.037125151604413986,"9":-0.99910569190979,"10":0.020236892625689507,"11":0,"12":0.8124555349349976,"13":1.0606516599655151,"14":1.422057032585144,"15":1}},"3":{"elements":{"0":-0.06107873097062111,"1":-0.025316588580608368,"2":0.9978117942810059,"3":0,"4":0.01366367656737566,"5":0.9995633959770203,"6":0.02619742602109909,"7":0,"8":-0.9980393648147583,"9":0.015233923681080341,"10":-0.06070612743496895,"11":0,"12":1.905739188194275,"13":0.08776523917913437,"14":4.382871627807617,"15":1}}}');

*/

/*
var tagOrientations = JSON.parse('{"0":{"elements":{"0":1,"1":0,"2":0,"3":0,"4":0,"5":1,"6":0,"7":0,"8":0,"9":0,"10":1,"11":0,"12":0,"13":0,"14":0,"15":1}},"1":{"elements":{"0":-0.052159782499074936,"1":0.011884236708283424,"2":-0.9985679984092712,"3":0,"4":0.027975914999842644,"5":0.9995541572570801,"6":0.010434695519506931,"7":0,"8":0.9982467889785767,"9":-0.027391590178012848,"10":-0.052469030022621155,"11":0,"12":-1.630102515220642,"13":0.09532264620065689,"14":1.961843490600586,"15":1}},"2":{"elements":{"0":0.014249232597649097,"1":-0.9993898868560791,"2":0.03188890591263771,"3":0,"4":0.01454993337392807,"5":-0.03168148547410965,"6":-0.999392032623291,"7":0,"8":0.9997926354408264,"9":0.014704497531056404,"10":0.014089589938521385,"11":0,"12":-1.3125767707824707,"13":0.9308427572250366,"14":1.1002248525619507,"15":1}},"3":{"elements":{"0":-0.0738251581788063,"1":0.006552829407155514,"2":-0.9972496628761292,"3":0,"4":-0.037842586636543274,"5":0.9992398023605347,"6":0.00936735887080431,"7":0,"8":0.9965529441833496,"9":0.038430046290159225,"10":-0.07352106273174286,"11":0,"12":-4.062390327453613,"13":-0.3329566717147827,"14":2.2645061016082764,"15":1}}}')
*/

var tagOrientations = JSON.parse('{"4":{"elements":{"0":1,"1":0,"2":0,"3":0,"4":0,"5":1,"6":0,"7":0,"8":0,"9":0,"10":1,"11":0,"12":0,"13":0,"14":0,"15":1}},"5":{"elements":{"0":0.8917704820632935,"1":0.38010653853416443,"2":0.2454882264137268,"3":0,"4":-0.34260907769203186,"5":0.921600878238678,"6":-0.18240302801132202,"7":0,"8":-0.2955748736858368,"9":0.0785551443696022,"10":0.9520843625068665,"11":0,"12":-6.024125099182129,"13":0.6585973501205444,"14":-0.09252260625362396,"15":1}},"6":{"elements":{"0":0.8618302345275879,"1":0.2558273375034332,"2":-0.4379509389400482,"3":0,"4":-0.47573986649513245,"5":0.7071012854576111,"6":-0.5231437087059021,"7":0,"8":0.17584110796451569,"9":0.6592118144035339,"10":0.7311084866523743,"11":0,"12":14.278733253479004,"13":2.2903361320495605,"14":-0.004331931006163359,"15":1}},"7":{"elements":{"0":0.8594264984130859,"1":0.3305879235267639,"2":0.38999709486961365,"3":0,"4":-0.2556627094745636,"5":0.9384849667549133,"6":-0.23212604224681854,"7":0,"8":-0.44274455308914185,"9":0.09978754073381424,"10":0.8910778164863586,"11":0,"12":10.419267654418945,"13":5.459832668304443,"14":10.548095703125,"15":1}},"8":{"elements":{"0":-0.1720122992992401,"1":0.07402843236923218,"2":-0.9823092818260193,"3":0,"4":0.1281503140926361,"5":0.9903802871704102,"6":0.052196234464645386,"7":0,"8":0.9767237901687622,"9":-0.11690487712621689,"10":-0.17984424531459808,"11":0,"12":-0.8350608348846436,"13":3.660140037536621,"14":2.9945430755615234,"15":1}},"9":{"elements":{"0":0.2858237326145172,"1":-0.19973938167095184,"2":-0.9372346997261047,"3":0,"4":-0.4147597551345825,"5":0.8558971881866455,"6":-0.30889222025871277,"7":0,"8":0.863874614238739,"9":0.47701597213745117,"10":0.1617918163537979,"11":0,"12":-6.749594688415527,"13":5.010570049285889,"14":3.8442790508270264,"15":1}},"10":{"elements":{"0":-0.06488533318042755,"1":0.12886391580104828,"2":-0.9895372986793518,"3":0,"4":0.06867246329784393,"5":0.9898526072502136,"6":0.1244020089507103,"7":0,"8":0.9955269694328308,"9":-0.05988209322094917,"10":-0.0730762854218483,"11":0,"12":-1.9745705127716064,"13":3.974928617477417,"14":2.7576181888580322,"15":1}},"11":{"elements":{"0":0.11946072429418564,"1":0.039181049913167953,"2":-0.9920655488967896,"3":0,"4":0.01646469160914421,"5":-0.9991617202758789,"6":-0.037478700280189514,"7":0,"8":-0.9927023649215698,"9":-0.011856802739202976,"10":-0.12000568211078644,"11":0,"12":4.886671543121338,"13":0.15832121670246124,"14":2.7315540313720703,"15":1}},"12":{"elements":{"0":-0.24561555683612823,"1":0.02590584196150303,"2":-0.9690211415290833,"3":0,"4":-0.4522688090801239,"5":0.8811107277870178,"6":0.13819116353988647,"7":0,"8":0.8573948740959167,"9":0.4721999764442444,"10":-0.2046981155872345,"11":0,"12":-3.7587332725524902,"13":2.0144667625427246,"14":12.177441596984863,"15":1}},"13":{"elements":{"0":-0.0911988765001297,"1":0.17952607572078705,"2":-0.979516863822937,"3":0,"4":0.18035751581192017,"5":0.9703269004821777,"6":0.16104939579963684,"7":0,"8":0.9793639779090881,"9":-0.16197572648525238,"10":-0.12087160348892212,"11":0,"12":-13.853669166564941,"13":-4.677957534790039,"14":4.30961275100708,"15":1}}}');



/*
      var tagOrientations = {}

      for (var i = 0; i <= 11; i++) {
        var relativeTagPos =  new THREE.Matrix4();
        relativeTagPos.makeTranslation( -1* (i%4)*7/4 , Math.floor(i/4)*7/4, 0 );
        tagOrientations[i] = relativeTagPos;


      }
      */
    // Globals

    var arController;
    var video;

    var renderer;
    var scene;
    var camera;
    var videoScene;
    var videoCamera;
    var cube;

    var bufferSize = 1;
    var ringBuffer = new Float32Array(16 * bufferSize);
    var ringIndex = 0;


    function setUpARController(video){
      arController = new ARController(video, 'camera_para.dat');
      arController.onload = function() {
        console.log('ARController ready for use', arController);
        setUpThreeJs();

        arController.setPatternDetectionMode( artoolkit.AR_MATRIX_CODE_DETECTION );

        tick();
      }
    }

    function setUpWebcam(){

      navigator.mediaDevices.enumerateDevices()
      .then(function(devices) {
        var id = 0;
        var fallbackId = 0;
        devices.forEach(function(device) {
          if (device.kind == "videoinput") {
            console.log(device)
            fallbackId = device.deviceId;
            if (device.label.search(/rear|back/) >= 0) {
              id = device.deviceId
              alert("using device: " + device.label)
            }
            if (id == 0) {
              id = fallbackId;
            }
          }
        });

        video = ARController.getUserMedia({
          //maxARVideoSize: 320, // do AR processing on scaled down video of this size
          maxARVideoSize: 320,
          video: {
            sourceId: id
          },
          onSuccess: function(video) {
            console.log('got video', video);
            setUpARController(video);

          }
        });
      });
    };

    function setUpThreeJs(){
      scene = new THREE.Scene();
      // fov is angle allowed, aspect is ration x gto y and near and far viewing plane
      // default position is z = 5
      //  camera is pointing down negative z axis
      // up is positive y - 3 is about limit of seeing at z = 0
      // right in positive x
      //camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );

      camera = new THREE.Camera();
      camera.matrixAutoUpdate = false;
      camera.projectionMatrix.elements.set(arController.getCameraMatrix());
      //camera.scale.x = 0.5;
      scene.add(camera);

      console.log(camera.projectionMatrix)

      renderer = new THREE.WebGLRenderer({ antialias: true });
      //renderer.setSize(video.videoWidth, video.videoHeight);

      var aspectRatio = video.videoWidth/video.videoHeight

      var drawWidth = window.innerWidth;
      var drawHeight = Math.floor(window.innerWidth * aspectRatio);

      renderer.setSize(video.videoWidth, video.videoHeight);
      renderer.setPixelRatio(3);
      document.body.appendChild( renderer.domElement );

      var light = new THREE.PointLight(0xffffff);
      light.position.set(400, 500, 100);
      scene.add(light);
      var light = new THREE.PointLight(0xffffff);
      light.position.set(-400, -500, -100);
      scene.add(light);

      var geometry = new THREE.BoxGeometry( 1, 1, 1 );

      drawEarth();




      // This was typo or changed pai in docs?
      var videoTex = new THREE.VideoTexture(video);

      videoTex.minFilter = THREE.LinearFilter;


      videoTex.flipY = false;

      var wv =1; //video.videoWidth;
      var hv =1; //video.videoHeight;
      var scaleFactor = 1;//wv/drawWidth
      var plane = new THREE.Mesh(
        new THREE.PlaneBufferGeometry(2, 2),  //2*wv/drawWidth / scaleFactor, 2*hv/drawHeight / scaleFactor),
        new THREE.MeshBasicMaterial({map: videoTex, side: THREE.DoubleSide})
      );


      plane.material.depthTest = false;
      plane.material.depthWrite = false;


      videoScene = new THREE.Scene();
      videoCamera = new THREE.OrthographicCamera(-1, 1, -1, 1, -1, 1);
      videoScene.add(videoCamera);
      videoScene.add(plane);

      // Set the renderer autoClear to false, otherwise it
      // clears the canvas before each render call.
      renderer.autoClear = false;
    }

    function tick(){
      requestAnimationFrame(tick);

      processTags();

      renderer.render( videoScene, videoCamera );


      renderer.render( scene, camera );
      //	console.log(cube);


    }

    function drawEarth() {
      var earthTextureMap = new THREE.TextureLoader().load('/images/earth/earthmap1k.jpg');
      var earthBumpMap = new THREE.TextureLoader().load('/images/earth/earthbump1k.jpg');
      var earthSpecularMap = new THREE.TextureLoader().load('/images/earth/earthspec1k.jpg')
      var earthCloudMap = new THREE.TextureLoader().load('/images/earth/earthcloudmap.jpg')
      var earthCloudMapTransp = new THREE.TextureLoader().load('/images/earth/earthcloudmaptransinvert.jpg')

      var earthGeometry = new THREE.SphereGeometry(2, 100, 100);
      var earthMaterial = new THREE.MeshPhongMaterial({
        map:earthTextureMap,
        bumpMap:earthBumpMap, bumpScale:.1,
        specularMap: earthSpecularMap
      });
      var earthMesh = new THREE.Mesh(earthGeometry, earthMaterial);
      earthMesh.position.set(-1, -1, 5);
      // earthMesh.rotation.z = 0.3;
      scene.add(earthMesh)


      var cloudGeometry = new THREE.SphereGeometry(2.1, 100, 100);
      var cloudMaterial = new THREE.MeshPhongMaterial({
        map: earthCloudMap,
        alphaMap: earthCloudMapTransp,
        side: THREE.DoubleSide,
        opacity: 0.8,
        transparent: true,
        depthWrite: false
      });
      var cloudMesh = new THREE.Mesh(cloudGeometry,cloudMaterial);
      earthMesh.add(cloudMesh)
    }

    var usedMarkerId = 0;
    var lastUsedMarkerId = 0;
    var usedMatrix = new Float32Array(12);
    var lastUsedMatrix = new Float32Array(12);

    function processTags() {



      ringIndex += 1;
      ringIndex = ringIndex % bufferSize;

      //arController.process(video);
      arController.detectMarker(video);

      var markerMatrix = new Float32Array(12);
      var glMatrix = new Float32Array(16);
      var avgMatrix = new Float32Array(16);


      var markers = arController.getMarkerNum();
      var largestArea = 0;

      for (var i=0; i < markers; i++) {

        var marker = arController.getMarker(i);

        if(marker.idMatrix > -1){

          if (marker.area > largestArea){
            maxIndex = marker.idMatrix;
            largestArea = marker.area;


            if (marker.idMatrix == lastUsedMarkerId) {
              arController.getTransMatSquareCont(i, 1 /* marker width */, lastUsedMatrix , markerMatrix);
              //arController.getTransMatSquare(i, 1 /* marker width */, markerMatrix);
            } else {
              arController.getTransMatSquare(i, 1 /* marker width */, markerMatrix);
            }
            usedMatrix = markerMatrix;
            usedMarkerId = marker.idMatrix;


            arController.transMatToGLMat(markerMatrix, glMatrix);
            var tagpos = new THREE.Matrix4();

            tagpos.elements.set(glMatrix);

            tagpos.multiply(tagOrientations[marker.idMatrix]);

          }

        }
      }
      lastUsedMarkerId = usedMarkerId;
      lastUsedMatrix = usedMatrix;


      if(largestArea > 0){

        //console.log(maxIndex);
        var smoothMatrix = new Float32Array(16);

        for(var j =0 ; j < 16; j++ ){

          ringBuffer[ ringIndex * 16 + j] = tagpos.elements[j];
          for(var k = 0; k < bufferSize ; k++){
            smoothMatrix[j] += ringBuffer[k * 16 + j] / bufferSize;
          }
        }


        var tagpos = new THREE.Matrix4()

        //tagpos.elements.set(avgMatrix);
        tagpos.elements.set(smoothMatrix);



        var camerapos = new THREE.Matrix4();
        camerapos.getInverse(tagpos);
        var transform2 = camerapos.toArray();
        camera.position.set(  transform2[12], transform2[13], transform2[14]);

        camera.setRotationFromMatrix(camerapos)
        camera.updateMatrix()

      }
    }

    document.body.onkeyup = function(e){
      if(e.keyCode == 32){
        //your code
        var geometry = new THREE.BoxGeometry( 1, 1, 1 );

        //var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
        var material = new THREE.MeshLambertMaterial({ color: 0xffffff, wireframe: false })
        var cube2 = new THREE.Mesh( geometry, material );
        cube2.position.z = camera.position.z;
        cube2.position.y = camera.position.y;
        cube2.position.x = camera.position.x;
        //cube.position.z

        scene.add(cube2)
        console.log(camera.position)

        console.log("CUBE ADDED")

      }
    }


    setUpWebcam();


  </script>

</html>
